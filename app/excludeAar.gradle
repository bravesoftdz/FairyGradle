configurations {
    exclude
}

//需要剔除的包名
def excludePackages = []
//需要剔除的文件名
def excludeClasses = []
//rule.txt里为需要替换的包名

task printMsg {
    group "Fairy"
    doLast {
        println getExcludePackageRegex(excludePackages)
        println getExcludeClassRegex(excludeClasses)
        file("./rule.txt").eachLine { line ->
            println line
        }
    }
}

def unZipAarFile = new File(buildDir, "unzipaar")
def unZipJarFile = new File(buildDir, 'unzipjar')
def excludeAarFile = new File(buildDir, "excludeaar")

//替换想要修改的sdk名字

def excludeAarName = "exclude_${getDefaultAar().name.replaceFirst(~/\.[^.]+$/, '')}"

def getDefaultAar() {
    Configuration c = configurations.getByName("default")
    def files = c.artifacts.files.filter {
        it.name ==~ /.*\.aar/
    }
    def file = null
    if (!files.empty) {
        file = files[0]
    }
    return file
}

task deleteDir(type: Delete) {
    delete unZipAarFile, unZipJarFile, excludeAarFile
}

deleteDir.dependsOn printMsg

task unZipAar(type: Copy) {
    def zipFile = getDefaultAar()
    def outputDir = unZipAarFile
    from zipTree(zipFile)
    into outputDir
}
unZipAar.dependsOn deleteDir

task unzipJar(type: Copy) {
    def zipFile = new File(unZipAarFile, 'classes.jar')
    def outputDir = unZipJarFile
    from zipTree(zipFile)
    into outputDir
}

unzipJar.dependsOn unZipAar

task zipJar(type: Jar) {
    baseName = 'classes'
    from unZipJarFile
    destinationDir unZipAarFile
    exclude getExcludePackageRegex(excludePackages)
    exclude getExcludeClassRegex(excludeClasses)
}

zipJar.dependsOn unzipJar


task replaceJar(type: Exec) {
    workingDir project.projectDir.absoluteFile
    commandLine "cmd", "/c", "java -jar jarjar-1.4.jar process rule.txt ./build/unzipaar/classes.jar ./build/unzipaar/classes.jar"
}

replaceJar.dependsOn zipJar

task excludeAar(type: Zip) {
    group 'Fairy'
    description 'aar内文件进行删除与重命名'
    baseName excludeAarName
    extension "aar"
    from unZipAarFile
    destinationDir excludeAarFile
}

excludeAar.dependsOn replaceJar

artifacts {
    exclude excludeAar
}


static def getExcludePackageRegex(def packages) {
    packages?.collect {
        it?.replace('.', '\\')?.plus("\\**")
    }
}

static def getExcludeClassRegex(def classes) {
    classes?.collect {
        it?.replace('.', '\\')?.plus(".class")
    }
}